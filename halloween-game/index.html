<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>åœ£è¯èŠ‚é…å¯¹æŒ‘æˆ˜</title>
<style>
  :root{
    --bg:#071116; --text:#f7f7fb;
    --panel:#0d2b2f; --panel2:#0a1f22;
    --tile:#0f2e33; --tile-hover:#154048; --tile-selected:#1a5b66;
    --violet:#9de6ff; --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 700px at 70% -200px,#08323a 0%,#052027 40%,#04141a 100%),
    var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji;}
  *{box-sizing:border-box}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 12px}
  .title{display:flex;gap:10px;align-items:center;font-weight:900;font-size:clamp(18px,2.6vw,26px)}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #194a51;border-radius:16px;padding:12px 14px;box-shadow:var(--shadow);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{padding:8px 12px;border-radius:999px;background:#0c2326;border:1px solid #1a4f56;font-weight:800}
  .btn{appearance:none;border:0;background:linear-gradient(180deg,#ffd0d0,#ff9b9b);color:#4b1111;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer;box-shadow:inset 0 -2px 0 rgba(0,0,0,.15),0 8px 16px rgba(0,0,0,.25);transition:.15s transform}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#14343a;color:#d7fbff;border:1px solid #1b5e67}
  .btn.tiny{padding:8px 10px;font-size:13px}
  .meter{position:relative;height:14px;background:#0b2024;border:1px solid #1a4f56;border-radius:999px;overflow:hidden;min-width:220px}
  .fill{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--green),#86efac);transition:width .35s ease}
  .stage-wrap{margin:14px 0}
  .stage{
    position:relative;width:100%;height: clamp(420px, 60vw, 640px);
    background:linear-gradient(180deg,rgba(14,47,53,.65),rgba(6,22,25,.65));
    border:1px solid #1a4f56;border-radius:18px;box-shadow:var(--shadow);overflow:hidden;
  }
  .tile{
    position:absolute;display:flex;align-items:center;justify-content:center;
    width:68px;height:68px;font-size:38px;line-height:1;
    background:var(--tile);border:1px solid #1a4f56;border-radius:18px;cursor:pointer;
    transition:.12s transform,.12s filter,.12s box-shadow,.12s background;user-select:none;
  }
  .tile:hover{background:var(--tile-hover)}
  .tile.selected{background:var(--tile-selected);box-shadow:0 0 0 3px var(--violet) inset,0 0 14px rgba(157,230,255,.35)}
  .tile.pop{animation:pop .35s both}
  @keyframes pop{0%{transform:scale(1)}30%{transform:scale(1.15)}100%{transform:scale(.1);opacity:0}}
  .overlay{position:fixed;inset:0;background:rgba(3,10,12,.75);display:none;align-items:center;justify-content:center;padding:20px;z-index:10}
  .dialog{max-width:640px;width:100%;background:linear-gradient(180deg,#0f2e33,#0a1f22);border:1px solid #1a5f66;border-radius:18px;box-shadow:var(--shadow);padding:22px}
  .levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:10px}
  .lv{padding:14px;border-radius:12px;background:#0c2326;border:1px solid #1a4f56;cursor:pointer;text-align:center;font-weight:900}
  /* å€’è®¡æ—¶çŠ¶æ€ + ç´§æ€¥æŠ–åŠ¨ */
  #timeLabel{background:#0e2a2f;border:1px solid #1a4f56;border-radius:999px;padding:8px 12px;font-weight:800}
  .time-ok #timeLabel{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
  .time-warn #timeLabel{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.45)}
  .time-danger #timeLabel{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.5)}
  .pulse{animation:pulse 1s infinite} @keyframes pulse{0%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}50%{filter:drop-shadow(0 0 10px rgba(255,255,255,.35))}100%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}}
  .shake{animation:shake .4s linear infinite}
  @keyframes shake{
    0%{ transform: translate(0px, 0px) rotate(0deg); }
    20%{ transform: translate(1px, -1px) rotate(-0.3deg); }
    40%{ transform: translate(-1px, 1px) rotate(0.3deg); }
    60%{ transform: translate(1px, 1px) rotate(0deg); }
    80%{ transform: translate(-1px, -1px) rotate(0.3deg); }
    100%{ transform: translate(0px, 0px) rotate(0deg); }
  }

  /* è¯ä¹¦é¢„è§ˆï¼šç¼©å°ã€ç­‰æ¯”ã€å¯å±…ä¸­ã€å¯ç‚¹å‡»åŸå›¾ */
  .cert-wrap{
    margin-top:12px;
    display:flex;
    justify-content:center;
  }
  .cert-wrap img{
    display:block;
    border-radius:12px;
    border:1px solid #1a4f56;
    width:auto;
    max-width:min(100%, 520px);
    max-height:clamp(180px, 32vh, 300px);
    object-fit:contain;
  }
  #endDialog { padding-bottom: 26px; }

  @media (max-width:600px){.tile{width:58px;height:58px;font-size:32px}}
</style>
</head>
<body>
<!-- æœ¬åœ° BGMï¼ˆä¸ index.html åŒç›®å½•æ”¾ç½® bgm.mp3ï¼‰ -->
<audio id="bgmTag" preload="auto" loop playsinline muted src="/bgm.mp3?v=20251103"></audio>

<div class="container">
  <header>
    <div class="title"><span>ğŸ„</span><span id="modeLabel">åœ£è¯èŠ‚é…å¯¹æŒ‘æˆ˜</span></div>
    <div class="panel" id="panel">
      <span class="badge" id="score">å¾—åˆ† 0</span>
      <span class="badge">å…³å¡ <span id="lvLabel">1</span></span>
      <div class="meter"><div class="fill" id="timeFill"></div></div>
      <span class="badge" id="timeLabel">å€’è®¡æ—¶ 0s</span>
      <button class="btn" id="btnSelect">é€‰å…³</button>
      <button class="btn tiny ghost" id="btnBgm">ğŸ”ˆ éŸ³ä¹å¼€</button>
    </div>
  </header>

  <div class="stage-wrap"><div class="stage" id="stage"></div></div>
  <footer>ğŸ§‘â€ğŸ„ è§„åˆ™ï¼šç‚¹å‡»ä¸¤å¼ ç›¸åŒå›¾æ¡ˆå³å¯é…å¯¹æ¶ˆé™¤ã€‚</footer>
</div>

<!-- é¦–é¡µï¼šä¸‰æ¨¡å¼ç‹¬ç«‹å…¥å£ -->
<div class="overlay" id="startOverlay" style="display:flex;">
  <div class="dialog">
    <h2>é€‰æ‹©æ¨¡å¼å¼€å§‹ ğŸ…</h2>
    <div class="levels">
      <button class="lv" id="btnEasy">ğŸ„ ç®€å•æ¨¡å¼</button>
      <button class="lv" id="btnNormal">ğŸ ä¸€èˆ¬æ¨¡å¼</button>
      <button class="lv" id="btnHard">â„ï¸ å›°éš¾æ¨¡å¼</button>
    </div>
    <p style="opacity:.8;margin-top:10px">æ¯ä¸ªæ¨¡å¼éƒ½æ˜¯ç‹¬ç«‹é—¯å…³çº¿è·¯ï¼ˆç¬¬1å…³ â†’ ç¬¬2å…³ â†’ ç¬¬3å…³ â€¦ï¼‰ï¼Œéš¾åº¦éšå…³å¡é€’å¢ã€‚</p>
  </div>
</div>

<!-- ç»“ç®—ï¼šèƒœåˆ©=å®Œæ•´ï¼›å¤±è´¥=æç®€ -->
<div class="overlay" id="endOverlay" style="display:none;">
  <div class="dialog" id="endDialog">
    <h2 id="endTitle">é€šå…³ï¼ğŸ</h2>
    <p id="endStats" class="dim"></p>

    <!-- èƒœåˆ©é¢æ¿ -->
    <div id="successPanel">
      <div class="dl-bar" style="margin-top:8px;">
        <div class="name-input" style="flex:1;display:flex;gap:8px;">
          <input id="nameInput" type="text" placeholder="è¾“å…¥åå­—/æ˜µç§°ï¼ˆå¯ç•™ç©ºï¼‰" maxlength="20"
                 style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid #1a4f56;background:#0c2326;color:#fff;font-weight:600;">
          <button class="btn ghost" id="btnUpdateCert">æ›´æ–°è¯ä¹¦</button>
        </div>
        <a class="btn" id="btnDownload" download="åœ£è¯èŠ‚è¯ä¹¦.png">ä¸‹è½½è¯ä¹¦</a>
        <button class="lv" id="btnNext">ä¸‹ä¸€å…³</button>
        <button class="lv" id="btnHome">è¿”å›é¦–é¡µ</button>
      </div>

      <!-- é¢„è§ˆå¯ç‚¹å¼€åŸå›¾ -->
      <div class="cert-wrap">
        <a id="certLink" href="#" target="_blank" rel="noopener">
          <img id="certImg" alt="è¯ä¹¦é¢„è§ˆ" />
        </a>
      </div>
    </div>

    <!-- å¤±è´¥é¢æ¿ï¼ˆæç®€ï¼‰ -->
    <div id="failPanel" style="display:none;text-align:center;margin-top:14px;">
      <button class="btn" id="btnRetry">å†æ¥ä¸€æ¬¡</button>
    </div>
  </div>
</div>

<script>
/* ========= æ¸…è„†éŸ³æ•ˆ ========= */
let AC;
function ensureAC(){
  if(!AC){
    const C = window.AudioContext || window.webkitAudioContext;
    AC = new C();
  }
  if(AC.state==='suspended') AC.resume();
}
function blip({fStart=1900,fEnd=900,dur=70,type='square',gain=0.045,when=0}) {
  ensureAC(); const t0=AC.currentTime+when/1000; const o=AC.createOscillator(); const g=AC.createGain();
  o.type=type; o.frequency.setValueAtTime(fStart,t0); o.frequency.exponentialRampToValueAtTime(fEnd,t0+dur/1000);
  g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(gain,t0+0.008); g.gain.exponentialRampToValueAtTime(1e-5,t0+dur/1000);
  o.connect(g).connect(AC.destination); o.start(t0); o.stop(t0+dur/1000+.02);
}
function sfxClick(){ blip({fStart:2000,fEnd:1200,dur:60,type:'triangle',gain:.05}); blip({fStart:3000,fEnd:1800,dur:40,type:'square',gain:.03,when:10}); }
function sfxWin(){ [800,1000,1200,1600].forEach((f,i)=>blip({fStart:f,fEnd:f/1.5,dur:120,type:'triangle',gain:.05,when:i*100})); }
function sfxBonus(){ blip({fStart:1400,fEnd:2200,dur:90,type:'triangle',gain:.045}); }

/* ========= æœ¬åœ° BGMï¼ˆé¦–æ¬¡è§¦æ‘¸å‡ºå£° + æŒ‰é’®åˆ‡æ¢ï¼‰ ========= */
const btnBgm=document.getElementById('btnBgm');
const bgmTag=document.getElementById('bgmTag');
const BGM = {
  enabled: true,
  setBtn(){ btnBgm.textContent = this.enabled ? 'ğŸ”ˆ éŸ³ä¹å¼€' : 'ğŸ”‡ éŸ³ä¹å…³'; },
  async ensurePlay() {
    if (!this.enabled) return;
    try {
      bgmTag.muted = false;
      bgmTag.volume = 0.35;
      if (bgmTag.readyState < 2) bgmTag.load();
      await bgmTag.play();
    } catch (_) {}
  },
  pause() { bgmTag.pause(); },
  toggle() {
    this.enabled = !this.enabled;
    this.setBtn();
    if (this.enabled) this.ensurePlay(); else this.pause();
  }
};
BGM.setBtn();
document.addEventListener('DOMContentLoaded', () => {
  bgmTag.muted = true;
  bgmTag.volume = 0.0;
  bgmTag.play().catch(()=>{});
});
['pointerdown','touchstart','click'].forEach(ev=>{
  document.addEventListener(ev, ()=>BGM.ensurePlay(), {once:true, passive:true});
});
btnBgm.onclick = ()=>BGM.toggle();
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible' && BGM.enabled) BGM.ensurePlay();
});

/* ========= åœ£è¯è¡¨æƒ…æ± ï¼ˆåªä¿ç•™ä¸€ç§ğŸ…å¤´åƒï¼Œé¿å…æ··æ·†ï¼‰ ========= */
const EMOJIS=[
  "ğŸ…","ğŸ„","ğŸ","ğŸ€","ğŸ§¦","ğŸ•¯ï¸","ğŸª","ğŸ¦Œ","ğŸ‰","ğŸ¬",
  "â›„","â„ï¸","ğŸŒŸ","ğŸ·","ğŸ¥›","ğŸ§¸","ğŸ””","ğŸª…","ğŸª„","ğŸ—"
];

/* ========= æ¨¡å¼é…ç½®ï¼ˆç‹¬ç«‹çº¿è·¯ & æ—¶é—´ç³»æ•°ï¼‰ ========= */
const MODES={
  easy:{ key:'easy',  title:'ç®€å•æ¨¡å¼',  bonusPerSec:5, base:{pairs:12,kinds:4,timeRaw:60}, perLevel:{pairs:+2,kindsEvery:2,kindsInc:+1,timeDecay:3,minTime:30} },
  normal:{ key:'normal',title:'ä¸€èˆ¬æ¨¡å¼',  bonusPerSec:6, base:{pairs:16,kinds:6,timeRaw:55}, perLevel:{pairs:+2,kindsEvery:2,kindsInc:+1,timeDecay:2,minTime:28} },
  hard:{ key:'hard',  title:'å›°éš¾æ¨¡å¼',  bonusPerSec:8, base:{pairs:20,kinds:8,timeRaw:50}, perLevel:{pairs:+2,kindsEvery:1,kindsInc:+1,timeDecay:1,minTime:25} }
};
const TIME_SCALE = 2/3; // å•å…³æ—¶é—´ç¼©çŸ­ä¸ºåŸæ¥çš„ 2/3

/* ========= çŠ¶æ€ & DOM ========= */
const stage=document.getElementById('stage'), scoreEl=document.getElementById('score'), lvLabel=document.getElementById('lvLabel'), modeLabel=document.getElementById('modeLabel');
const timeFill=document.getElementById('timeFill'), timeLabel=document.getElementById('timeLabel'), panel=document.getElementById('panel');
const startOverlay=document.getElementById('startOverlay'), endOverlay=document.getElementById('endOverlay');
const endTitle=document.getElementById('endTitle'), endStats=document.getElementById('endStats');
const successPanel=document.getElementById('successPanel'), failPanel=document.getElementById('failPanel');
const nameInput=document.getElementById('nameInput'), btnUpdateCert=document.getElementById('btnUpdateCert'), btnDownload=document.getElementById('btnDownload'), certImg=document.getElementById('certImg'), certLink=document.getElementById('certLink');
const btnNext=document.getElementById('btnNext'), btnHome=document.getElementById('btnHome'), btnRetry=document.getElementById('btnRetry');
const btnEasy=document.getElementById('btnEasy'), btnNormal=document.getElementById('btnNormal'), btnHard=document.getElementById('btnHard'), btnSelect=document.getElementById('btnSelect');

let state={ mode:MODES.easy, lv:1, score:0, lock:false, picked:null, tiles:[], startTime:0, timeLeft:0, finalScore:0, lastWin:true };

/* ========= äº‹ä»¶ç»‘å®š ========= */
btnEasy.onclick = ()=>startMode(MODES.easy);
btnNormal.onclick= ()=>startMode(MODES.normal);
btnHard.onclick = ()=>startMode(MODES.hard);
btnSelect.onclick= ()=>{
  clearTimer(); endOverlay.style.display='none'; startOverlay.style.display='flex';
  stage.innerHTML=''; timeFill.style.width='0'; scoreEl.textContent='å¾—åˆ† 0'; lvLabel.textContent='-'; modeLabel.textContent='åœ£è¯èŠ‚é…å¯¹æŒ‘æˆ˜';
  state.lock=false; state.picked=null; state.tiles=[];
};
/* é¢„çƒ­éŸ³é¢‘ä¸Šä¸‹æ–‡ */
document.body.addEventListener('pointerdown', ensureAC, {once:true});

/* ========= å…¥å£ & é…ç½® ========= */
function startMode(mode){
  state.mode=mode; state.lv=1; BGM.ensurePlay(); startLevel(1);
}
function getLevelConfig(mode, level){
  const base=mode.base, inc=mode.perLevel;
  const pairs = base.pairs + (level-1)*inc.pairs;
  const kinds = base.kinds + Math.floor((level-1)/inc.kindsEvery)*inc.kindsInc;
  const timeRaw = Math.max(inc.minTime, base.timeRaw - (level-1)*inc.timeDecay);
  const time = Math.max(1, Math.round(timeRaw * TIME_SCALE));
  return {pairs,kinds,time,level};
}

/* ========= å€’è®¡æ—¶ ========= */
let timerId=null, timerTotal=0, emergencyOn=false;
function clearTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } emergencyOn=false; stage.classList.remove('shake'); timeFill.classList.remove('pulse'); timeLabel.classList.remove('pulse'); panel.classList.remove('time-ok','time-warn','time-danger'); }
function startTimer(seconds){
  clearTimer(); timerTotal=seconds; state.timeLeft=seconds; updateTimerUI();
  timerId=setInterval(()=>{ state.timeLeft-=1; updateTimerUI(); if(state.timeLeft<=0){ clearTimer(); showEnd(false);} },1000);
}
function updateTimerUI(){
  timeLabel.textContent = `å€’è®¡æ—¶ ${Math.max(0,state.timeLeft)}s`;
  const pct = timerTotal>0 ? (state.timeLeft/timerTotal)*100 : 0;
  timeFill.style.width = Math.max(0,Math.min(100,pct))+'%';
  panel.classList.remove('time-ok','time-warn','time-danger');
  if(pct>50){ panel.classList.add('time-ok'); timeFill.style.background='linear-gradient(90deg,var(--green),#86efac)'; timeFill.classList.remove('pulse'); timeLabel.classList.remove('pulse'); stage.classList.remove('shake'); emergencyOn=false; }
  else if(pct>20){ panel.classList.add('time-warn'); timeFill.style.background='linear-gradient(90deg,var(--amber),#fde68a)'; timeFill.classList.remove('pulse'); timeLabel.classList.remove('pulse'); stage.classList.remove('shake'); emergencyOn=false; }
  else{ panel.classList.add('time-danger'); timeFill.style.background='linear-gradient(90deg,var(--red),#fca5a5)'; if(state.timeLeft<=10){ timeFill.classList.add('pulse'); timeLabel.classList.add('pulse'); stage.classList.add('shake'); if(!emergencyOn){ emergencyOn=true; if(navigator.vibrate) navigator.vibrate(120);} } else { timeFill.classList.remove('pulse'); timeLabel.classList.remove('pulse'); stage.classList.remove('shake'); emergencyOn=false; } }
}

/* ========= å¼€å§‹å…³å¡ ========= */
function startLevel(level){
  ensureAC();
  const cfg=getLevelConfig(state.mode, level);
  state.lv=level; state.score=0; state.lock=false; state.picked=null; state.startTime=Date.now();
  scoreEl.textContent='å¾—åˆ† 0'; lvLabel.textContent=level;
  modeLabel.textContent=`åœ£è¯èŠ‚é…å¯¹æŒ‘æˆ˜ Â· ${state.mode.title}`;
  buildScene(cfg);
  startTimer(cfg.time);
  startOverlay.style.display='none'; endOverlay.style.display='none';
}

/* ========= éšæœºæ•£è½å¡ç‰‡ ========= */
function randInt(n){return Math.floor(Math.random()*n);}
function randFloat(a,b){return a+Math.random()*(b-a);}
function buildScene(cfg){
  stage.innerHTML=''; state.tiles=[];
  const pool=[];
  for(let i=0;i<cfg.pairs;i++){ const k=randInt(cfg.kinds); pool.push(k,k); }
  for(let i=pool.length-1;i>0;i--){ const j=randInt(i+1); [pool[i],pool[j]]=[pool[j],pool[i]]; }

  const rect=stage.getBoundingClientRect(), W=rect.width, H=rect.height, pad=10, TW=68, TH=68;
  for(const v of pool){
    const el=document.createElement('div');
    el.className='tile'; el.textContent=EMOJIS[v % EMOJIS.length]; el.dataset.v=v;
    const x=randFloat(pad, Math.max(pad, W-TW-pad)), y=randFloat(pad, Math.max(pad, H-TH-pad));
    el.style.left=x+'px'; el.style.top=y+'px';
    el.onclick=()=>onPick(el,v,cfg);
    stage.appendChild(el);
    state.tiles.push({el,v});
  }
}

/* ========= ç‚¹å‡»é…å¯¹ ========= */
function onPick(el,v,cfg){
  sfxClick();
  if(state.lock) return;
  if(!state.picked){ state.picked={el,v}; el.classList.add('selected'); return; }
  if(state.picked.el===el) return;

  if(state.picked.v!==v){
    state.picked.el.classList.remove('selected');
    state.picked={el,v}; el.classList.add('selected');
    return;
  }

  // ç›¸åŒï¼šæ¶ˆé™¤
  state.lock=true;
  const a=state.picked.el, b=el;
  a.classList.remove('selected'); a.classList.add('pop'); b.classList.add('pop');
  setTimeout(()=>{
    a.remove(); b.remove();
    state.tiles=state.tiles.filter(t=>t.el!==a && t.el!==b);
    state.lock=false; state.picked=null;

    state.score+=10; scoreEl.textContent=`å¾—åˆ† ${state.score}`;

    // ä½å…³å¡åŠ æ—¶å¥–åŠ±ï¼ˆç¤ºä¾‹ï¼šå‰ä¸¤å…³æ¯æ¶ˆä¸€å¯¹ +1sï¼‰
    if(state.lv<=2){
      const before = state.timeLeft;
      state.timeLeft = Math.min(timerTotal, state.timeLeft + 1);
      if(state.timeLeft>before){ sfxBonus(); updateTimerUI(); }
    }

    if(state.tiles.length===0) showEnd(true,cfg);
  },250);
}

/* ========= ç»“ç®— & è¯ä¹¦ ========= */
function showEnd(win,cfg){
  clearTimer();
  const elapsed=Math.round((Date.now()-state.startTime)/1000);
  // æ—¶é—´å¥–åŠ±ï¼ˆé€šå…³æ‰æœ‰ï¼‰
  const timeBonus = win ? Math.max(0, Math.round(state.timeLeft * state.mode.bonusPerSec)) : 0;
  state.finalScore = state.score + timeBonus;
  state.lastWin = win;

  endTitle.textContent=win?'é€šå…³ï¼ğŸ':'æ—¶é—´åˆ°ï¼ğŸ…';
  const bonusText = timeBonus>0 ? `ï¼ˆæ—¶é—´å¥–åŠ± +${timeBonus}ï¼‰` : '';
  endStats.textContent=`æ¨¡å¼ï¼š${state.mode.title} ï½œ å…³å¡ï¼š${state.lv} ï½œ å¾—åˆ†ï¼š${state.finalScore}${bonusText} ï½œ ç”¨æ—¶ï¼š${elapsed}s`;

  if(win){
    // èƒœåˆ©ï¼šæ˜¾ç¤ºå®Œæ•´é¢æ¿å¹¶ç”Ÿæˆè¯ä¹¦
    successPanel.style.display='block';
    failPanel.style.display='none';
    const name = nameInput.value?.trim() || 'ç¥ç§˜ç©å®¶';
    const url = makeCert({
      name, score:state.finalScore, time:elapsed, lv:state.lv, mode:state.mode.title, win:true
    });
    certImg.src = url; btnDownload.href = url; if (certLink) certLink.href = url;
    // ä¸‹è½½æ–‡ä»¶åæ›´å‹å¥½
    btnDownload.download = `åœ£è¯èŠ‚è¯ä¹¦_Lv${state.lv}_${name}.png`;
    sfxWin();
  }else{
    // å¤±è´¥ï¼šæç®€é¢æ¿
    successPanel.style.display='none';
    failPanel.style.display='block';
  }

  // æŒ‰é’®è¡Œä¸º
  btnRetry.onclick = ()=>{ endOverlay.style.display='none'; startLevel(state.lv); };
  btnHome.onclick  = ()=>{ endOverlay.style.display='none'; startOverlay.style.display='flex'; };
  btnNext.onclick  = ()=>{ endOverlay.style.display='none'; startLevel(state.lv+1); };
  btnUpdateCert.onclick = ()=>{
    const name = nameInput.value?.trim() || 'ç¥ç§˜ç©å®¶';
    const info = /ç”¨æ—¶ï¼š(\d+)s/.test(endStats.textContent) ? parseInt(RegExp.$1,10) : elapsed;
    const url = makeCert({
      name, score:state.finalScore, time:info, lv:state.lv, mode:state.mode.title, win: state.lastWin
    });
    certImg.src = url; btnDownload.href = url; if (certLink) certLink.href = url;
    btnDownload.download = `åœ£è¯èŠ‚è¯ä¹¦_Lv${state.lv}_${name}.png`;
  };

  endOverlay.style.display='flex';
}

/* === è¯ä¹¦ç»˜åˆ¶ï¼šè‡ªåŠ¨åŒºåˆ†é€šå…³/å¤±è´¥çŠ¶æ€ï¼ˆæŒ‰ä½ æˆªå›¾æ’ç‰ˆï¼‰ === */
function makeCert({name,score,time,lv,mode,win=true}){
  const w=900,h=600;
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  const ctx=c.getContext('2d');

  // èƒŒæ™¯
  const bg=ctx.createLinearGradient(0,0,0,h);
  bg.addColorStop(0,'#08323a');
  bg.addColorStop(1,'#061c21');
  ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);

  // å¤–æ¡†
  const border=ctx.createLinearGradient(20,20,w-20,h-20);
  border.addColorStop(0,'#22c55e');
  border.addColorStop(1,'#ef4444');
  ctx.strokeStyle=border; ctx.lineWidth=6;
  ctx.strokeRect(20,20,w-40,h-40);

  // æ ‡é¢˜
  ctx.fillStyle='#ffffff';
  ctx.textAlign='center';
  ctx.textBaseline='alphabetic';
  ctx.font='900 56px system-ui, -apple-system, Segoe UI, Roboto';
  ctx.fillText('åœ£è¯èŠ‚é…å¯¹æŒ‘æˆ˜', w/2, 115);

  // é¢å‘ç»™
  const nick = name && name.trim() ? name.trim() : 'ç¥ç§˜ç©å®¶';
  ctx.fillStyle='#9de6ff';
  ctx.font='600 34px system-ui, -apple-system, Segoe UI, Roboto';
  ctx.fillText(`é¢å‘ç»™ï¼š ${nick}`, w/2, 170);

  // ğŸ„ é€šå…³è®¤è¯ / æŒ‘æˆ˜ç»“æŸ
  const label = win ? 'é€šå…³è®¤è¯' : 'æŒ‘æˆ˜ç»“æŸ';
  const color = win ? '#86efac' : '#ff6b6b';
  ctx.textAlign='center';
  ctx.font='36px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui';
  ctx.fillText('ğŸ„', w/2 - 60, 215);
  ctx.font='600 32px system-ui, -apple-system, Segoe UI, Roboto';
  ctx.fillStyle=color;
  ctx.fillText(label, w/2 + 20, 215);

  // å·¦å¯¹é½ä¿¡æ¯åˆ—è¡¨
  const startX = 120;
  let y = 270;
  const lh = 52;
  const labelColor = '#bfe9ff';
  const valueColor = '#e7faff';
  const labelFont  = '600 28px system-ui, -apple-system, Segoe UI, Roboto';
  const valueFont  = '600 28px system-ui, -apple-system, Segoe UI, Roboto';

  function row(label, value){
    ctx.textAlign='left';
    ctx.fillStyle=labelColor; ctx.font=labelFont;
    ctx.fillText(label, startX, y);
    ctx.fillStyle=valueColor; ctx.font=valueFont;
    ctx.fillText(value, startX + 90, y);
    y += lh;
  }

  row('æ¨¡å¼ï¼š', mode);
  row('å…³å¡ï¼š', `Lv.${lv}`);
  row('å¾—åˆ†ï¼š', `${score}`);
  row('ç”¨æ—¶ï¼š', `${time}s`);
  row('æ—¶é—´ï¼š', new Date().toLocaleString('zh-CN',{hour12:false}));

  // åº•éƒ¨ç¥è´ºè¯­
  ctx.textAlign='center';
  ctx.fillStyle='#bfe9ff';
  ctx.font='600 22px system-ui, -apple-system, Segoe UI, Roboto';
  ctx.fillText('æ­å–œè·å¾—æœ¬æ¬¡åœ£è¯é…å¯¹æŒ‘æˆ˜è¯ä¹¦ ğŸ§‘â€ğŸ„ï¼ˆå¯åˆ†äº«ï¼‰', w/2, h - 60);

  return c.toDataURL('image/png');
}
</script>
</body>
</html>
