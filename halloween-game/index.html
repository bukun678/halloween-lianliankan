<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ä¸‡åœ£èŠ‚é…å¯¹æŒ‘æˆ˜</title>
<style>
  :root{
    --bg:#0b0b1a;--text:#f7f7fb;--panel:#151532;--panel2:#0f0f23;
    --tile:#1d1d36;--tile-hover:#2a2a55;--tile-selected:#3a3a7a;
    --violet:#7e5cef;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 700px at 70% -200px,#1a1440 0%,#0d0b1d 40%,#070711 100%),
    var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji;}
  *{box-sizing:border-box}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 12px}
  .title{display:flex;gap:10px;align-items:center;font-weight:900;font-size:clamp(18px,2.6vw,26px)}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #27275a;border-radius:16px;padding:12px 14px;box-shadow:var(--shadow);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{padding:8px 12px;border-radius:999px;background:#1b1b3a;border:1px solid #2a2a58;font-weight:800;transition:.2s background,.2s border-color,.2s transform}
  .btn{appearance:none;border:0;background:linear-gradient(180deg,#ffb454,#ff9640);color:#3b1800;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer;box-shadow:inset 0 -2px 0 rgba(0,0,0,.15),0 8px 16px rgba(0,0,0,.25);transition:.15s transform,.15s filter}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#1f1f3f;color:#c5c6ff;border:1px solid #2a2a63}
  .meter{position:relative;height:14px;background:#1b1b36;border:1px solid #2a2a52;border-radius:999px;overflow:hidden;min-width:200px}
  .fill{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--green),#86efac);transition:width .35s ease, background .2s ease, filter .2s ease}
  .stage-wrap{margin:14px 0}
  .stage{
    position:relative;width:100%;height: clamp(420px, 60vw, 640px);
    background:linear-gradient(180deg,rgba(20,20,50,.65),rgba(10,10,30,.65));
    border:1px solid #26265a;border-radius:18px;box-shadow:var(--shadow);overflow:hidden;
  }
  .tile{
    position:absolute;display:flex;align-items:center;justify-content:center;
    width:68px;height:68px;font-size:38px;line-height:1;
    background:var(--tile);border:1px solid #2a2a58;border-radius:18px;cursor:pointer;
    transition:.12s transform,.12s filter,.12s box-shadow,.12s background;user-select:none;
  }
  .tile:hover{background:var(--tile-hover)}
  .tile.selected{background:var(--tile-selected);box-shadow:0 0 0 3px var(--violet) inset,0 0 14px rgba(126,92,239,.4)}
  .tile.pop{animation:pop .35s both}
  @keyframes pop{0%{transform:scale(1)}30%{transform:scale(1.15)}100%{transform:scale(.1);opacity:0}}
  .overlay{position:fixed;inset:0;background:rgba(6,6,14,.75);display:none;align-items:center;justify-content:center;padding:20px;z-index:10}
  .dialog{max-width:640px;width:100%;background:linear-gradient(180deg,#161634,#0e0e22);border:1px solid #2a2a58;border-radius:18px;box-shadow:var(--shadow);padding:22px}
  .levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:10px}
  .lv{padding:12px 14px;border-radius:12px;background:#1b1b3a;border:1px solid #2a2a58;cursor:pointer;text-align:center;font-weight:800}
  .cert-wrap{margin-top:12px}
  .cert-wrap img{width:100%;border-radius:12px;border:1px solid #2a2a58;display:block}
  .dl-bar{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;align-items:center}
  .name-input{display:flex;gap:8px;flex:1}
  .name-input input{flex:1;padding:8px 10px;border-radius:8px;border:1px solid #2a2a58;background:#1b1b3a;color:#fff;font-weight:600;}
  footer{opacity:.8;text-align:center;margin:10px 0}

  /* å€’è®¡æ—¶é¢œè‰²çŠ¶æ€ */
  #timeLabel{background:#1e293b;border-color:#334155}
  .time-ok #timeLabel{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
  .time-warn #timeLabel{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.45)}
  .time-danger #timeLabel{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.5);transform:scale(1.02)}

  /* ç´§æ€¥è„‰å†²é—ªçƒ */
  .pulse{animation:pulse 1s infinite}
  @keyframes pulse{0%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}50%{filter:drop-shadow(0 0 10px rgba(255,255,255,.35))}100%{filter:drop-shadow(0 0 0 rgba(255,255,255,0))}}

  /* â‰¤10s è½»å¾®æŠ–åŠ¨ï¼ˆèˆå°ï¼‰ */
  .shake{animation:shake .4s linear infinite}
  @keyframes shake{
    0%{ transform: translate(0px, 0px) rotate(0deg); }
    20%{ transform: translate(1px, -1px) rotate(-0.3deg); }
    40%{ transform: translate(-1px, 1px) rotate(0.3deg); }
    60%{ transform: translate(1px, 1px) rotate(0deg); }
    80%{ transform: translate(-1px, -1px) rotate(0.3deg); }
    100%{ transform: translate(0px, 0px) rotate(0deg); }
  }

  @media (max-width:600px){.tile{width:58px;height:58px;font-size:32px}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="title"><span>ğŸŒ•</span><span>ä¸‡åœ£èŠ‚é…å¯¹æŒ‘æˆ˜</span></div>
    <div class="panel" id="panel">
      <span class="badge" id="score">å¾—åˆ† 0</span>
      <span class="badge" id="combo">è¿å‡» x1</span>
      <span class="badge">å…³å¡ <span id="lvLabel">1</span></span>

      <!-- è¿›åº¦æ¡ + å€’è®¡æ—¶æ•°å­— -->
      <div class="meter"><div class="fill" id="timeFill"></div></div>
      <span class="badge" id="timeLabel">å€’è®¡æ—¶ 0s</span>

      <button class="btn" id="btnRestart">é‡å¼€</button>
    </div>
  </header>

  <div class="stage-wrap"><div class="stage" id="stage"></div></div>
  <footer>ğŸƒ è§„åˆ™ï¼šç‚¹å‡»ä¸¤å¼ ç›¸åŒå›¾æ¡ˆå³å¯é…å¯¹æ¶ˆé™¤ã€‚</footer>
</div>

<!-- æ¬¢è¿é¡µï¼ˆ3å…³ï¼‰ -->
<div class="overlay" id="startOverlay">
  <div class="dialog">
    <h2>ä¸‡åœ£å¤œå¼€å§‹å•¦ ğŸ‘»</h2>
    <p class="dim">é€‰æ‹©å…³å¡å¼€å§‹æ¸¸æˆï¼š</p>
    <div class="levels" id="levels"></div>
  </div>
</div>

<!-- ç»“ç®—é¡µï¼ˆè¾“å…¥æ˜µç§° & å³æ—¶åˆ·æ–°è¯ä¹¦ï¼‰ -->
<div class="overlay" id="endOverlay" style="display:none;">
  <div class="dialog">
    <h2 id="endTitle">é€šå…³ï¼</h2>
    <p id="endStats" class="dim"></p>

    <div class="dl-bar">
      <div class="name-input">
        <input id="nameInput" type="text" placeholder="è¾“å…¥åå­—/æ˜µç§°ï¼ˆå¯ç•™ç©ºï¼‰" maxlength="20" />
        <button class="btn ghost" id="btnUpdateCert">æ›´æ–°è¯ä¹¦</button>
      </div>
      <a class="btn" id="btnDownload" download="ä¸‡åœ£èŠ‚è¯ä¹¦.png">ä¸‹è½½è¯ä¹¦.png</a>
      <button class="lv" id="btnAgain">å†ç©ä¸€æ¬¡</button>
      <button class="lv" id="btnNext">ä¸‹ä¸€å…³</button>
    </div>

    <div class="cert-wrap"><img id="certImg" alt="è¯ä¹¦é¢„è§ˆ" /></div>
  </div>
</div>

<script>
/** ---------- é…ç½®ï¼ˆ3 å…³ + ä½éš¾åº¦ï¼‰ ---------- */
const EMOJIS=["ğŸƒ","ğŸ‘»","ğŸ¦‡","ğŸ•·ï¸","ğŸ•¸ï¸","ğŸ¬","ğŸ’€","ğŸˆâ€â¬›","ğŸ§™â€â™€ï¸","ğŸ­"];
const LEVELS=[{pairs:12,kinds:4,time:45},{pairs:16,kinds:6,time:60},{pairs:20,kinds:8,time:75}];
const TIME_SCALE = 2/3; // å…³å¡æ—¶é—´ç¼©çŸ­ä¸ºåŸæ¥çš„ 2/3
const TILE_SIZE=68;

/** ---------- æ¸…è„†ç‚¹å‡» & é€šå…³éŸ³æ•ˆï¼ˆWebAudioï¼‰ ---------- */
let AC;
function ensureAC(){ if(!AC){ const C=window.AudioContext||window.webkitAudioContext; AC=new C(); } if(AC.state==='suspended') AC.resume(); }
function blip({fStart=1900,fEnd=900,dur=70,type='square',gain=0.045,when=0}) {
  ensureAC(); const t0=AC.currentTime+when/1000; const o=AC.createOscillator(); const g=AC.createGain();
  o.type=type; o.frequency.setValueAtTime(fStart,t0); o.frequency.exponentialRampToValueAtTime(fEnd,t0+dur/1000);
  g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(gain,t0+0.008); g.gain.exponentialRampToValueAtTime(1e-5,t0+dur/1000);
  o.connect(g).connect(AC.destination); o.start(t0); o.stop(t0+dur/1000+.02);
}
function sfxClick(){ blip({fStart:2000,fEnd:1200,dur:60,type:'triangle',gain:.05}); blip({fStart:3000,fEnd:1800,dur:40,type:'square',gain:.03,when:10}); }
function sfxWin(){ [800,1000,1200,1600].forEach((f,i)=>blip({fStart:f,fEnd:f/1.5,dur:120,type:'triangle',gain:.05,when:i*100})); }
// å¥–åŠ±éŸ³ï¼ˆçŸ­ä¿ƒä¸Šæ‰¬ï¼‰
function sfxBonus(){ blip({fStart:1400,fEnd:2200,dur:90,type:'triangle',gain:.045}); }

/** ---------- çŠ¶æ€ ---------- */
let state={
  lv:0, score:0, combo:1, bestCombo:1, lock:false,
  picked:null, tiles:[], startTime:0, name:'',
  timeLeft:0
};

// DOM
const stage=document.getElementById('stage');
const scoreEl=document.getElementById('score');
const comboEl=document.getElementById('combo');
const lvLabel=document.getElementById('lvLabel');
const timeFill=document.getElementById('timeFill');
const timeLabel=document.getElementById('timeLabel');
const panel=document.getElementById('panel');

const startOverlay=document.getElementById('startOverlay');
const levelsEl=document.getElementById('levels');

const endOverlay=document.getElementById('endOverlay');
const endTitle=document.getElementById('endTitle');
const endStats=document.getElementById('endStats');
const nameInput=document.getElementById('nameInput');
const btnUpdateCert=document.getElementById('btnUpdateCert');
const btnDownload=document.getElementById('btnDownload');
const certImg=document.getElementById('certImg');

const btnRestart=document.getElementById('btnRestart');
const btnAgain=document.getElementById('btnAgain');
const btnNext=document.getElementById('btnNext');

// å·¥å…·
function randInt(n){return Math.floor(Math.random()*n);}
function randFloat(a,b){return a+Math.random()*(b-a);}

/** ---------- å€’è®¡æ—¶ï¼ˆå¸¦è¿›åº¦æ¡ + é¢œè‰² + è„‰å†² + æŠ–åŠ¨ï¼‰ ---------- */
let timerId=null, timerTotal=0;
let emergencyOn=false; // è¿›å…¥ç´§æ€¥æ€ï¼ˆâ‰¤10sï¼‰åªè§¦å‘ä¸€æ¬¡éœ‡åŠ¨
function clearTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } emergencyOn=false; stage.classList.remove('shake'); timeFill.classList.remove('pulse'); timeLabel.classList.remove('pulse'); panel.classList.remove('time-ok','time-warn','time-danger'); }
function startTimer(seconds){
  clearTimer();
  timerTotal = seconds;
  state.timeLeft = seconds;
  updateTimerUI();
  timerId = setInterval(()=>{
    state.timeLeft -= 1;
    updateTimerUI();
    if(state.timeLeft<=0){
      clearTimer();
      showEnd(false); // æ—¶é—´åˆ°ï¼Œåˆ¤è´Ÿ
    }
  },1000);
}
function updateTimerUI(){
  // æ•°å­—
  if(timeLabel) timeLabel.textContent = `å€’è®¡æ—¶ ${Math.max(0, state.timeLeft)}s`;

  // è¿›åº¦æ¡ & è‰²é˜¶
  const pct = timerTotal>0 ? (state.timeLeft/timerTotal)*100 : 0;
  timeFill.style.width = Math.max(0, Math.min(100, pct)) + '%';

  // æ ¹æ®é˜ˆå€¼åˆ‡æ¢é¢œè‰²ä¸çŠ¶æ€ç±»
  panel.classList.remove('time-ok','time-warn','time-danger');
  if(pct > 50){
    panel.classList.add('time-ok');
    timeFill.style.background = 'linear-gradient(90deg,var(--green),#86efac)';
    timeFill.classList.remove('pulse');
    timeLabel.classList.remove('pulse');
    stage.classList.remove('shake');
    emergencyOn=false;
  }else if(pct > 20){
    panel.classList.add('time-warn');
    timeFill.style.background = 'linear-gradient(90deg,var(--amber),#fde68a)';
    timeFill.classList.remove('pulse');
    timeLabel.classList.remove('pulse');
    stage.classList.remove('shake');
    emergencyOn=false;
  }else{
    panel.classList.add('time-danger');
    timeFill.style.background = 'linear-gradient(90deg,var(--red),#fca5a5)';

    // <10s å¼€å¯è„‰å†² & æŠ–åŠ¨
    if(state.timeLeft <= 10){
      timeFill.classList.add('pulse');
      timeLabel.classList.add('pulse');
      stage.classList.add('shake');

      // ä»…ç¬¬ä¸€æ¬¡è¿›å…¥ç´§æ€¥æ€æ—¶éœ‡åŠ¨ä¸€ä¸‹ï¼ˆç§»åŠ¨ç«¯ï¼‰
      if(!emergencyOn){
        emergencyOn = true;
        if('vibrate' in navigator){ navigator.vibrate(120); }
      }
    }else{
      timeFill.classList.remove('pulse');
      timeLabel.classList.remove('pulse');
      stage.classList.remove('shake');
      emergencyOn=false;
    }
  }
}

/** å…³å¡é€‰æ‹©ï¼ˆ3å…³ï¼Œæ˜¾ç¤ºç¼©çŸ­åæ—¶é—´ï¼‰ */
LEVELS.forEach((lv,i)=>{
  const b=document.createElement('button');
  b.className='lv';
  const t = Math.max(1, Math.round(lv.time * TIME_SCALE));
  b.innerHTML=`Lv.${i+1}<br><span class="dim">${lv.pairs*2}å¼  / ${lv.kinds}ç§ / ${t}s</span>`;
  b.onclick=()=>{ ensureAC(); startGame(i); };
  levelsEl.appendChild(b);
});
startOverlay.style.display='flex';
document.body.addEventListener('pointerdown', ensureAC, {once:true});

/** å¼€å§‹/é‡å¼€/ä¸‹ä¸€å…³ */
function startGame(i){
  const cfg=LEVELS[i];
  state.lv=i; state.score=0; state.combo=1; state.bestCombo=1; state.lock=false;
  state.picked=null; state.startTime=Date.now();
  scoreEl.textContent='å¾—åˆ† 0'; comboEl.textContent='è¿å‡» x1'; lvLabel.textContent=i+1;
  buildScene(cfg);
  const seconds = Math.max(1, Math.round(cfg.time * TIME_SCALE)); // ä½¿ç”¨ç¼©çŸ­åçš„æ—¶é—´
  startTimer(seconds);
  startOverlay.style.display='none';
  endOverlay.style.display='none';
}
btnRestart.onclick=()=>startGame(state.lv);
btnAgain.onclick=()=>startGame(state.lv);
btnNext.onclick=()=>startGame(Math.min(state.lv+1,LEVELS.length-1));

/** éšæœºæ•£è½å¡ç‰‡ */
function buildScene(cfg){
  stage.innerHTML=''; state.tiles=[];
  const pool=[];
  for(let i=0;i<cfg.pairs;i++){ const k=randInt(cfg.kinds); pool.push(k,k); }
  for(let i=pool.length-1;i>0;i--){ const j=randInt(i+1); [pool[i],pool[j]]=[pool[j],pool[i]]; }

  const rect=stage.getBoundingClientRect(), W=rect.width, H=rect.height, pad=10;
  for(const v of pool){
    const el=document.createElement('div');
    el.className='tile'; el.textContent=EMOJIS[v]; el.dataset.v=v;
    const x=randFloat(pad, W-68-pad), y=randFloat(pad, H-68-pad);
    el.style.left=x+'px'; el.style.top=y+'px';
    el.onclick=()=>onPick(el,v);
    stage.appendChild(el);
    state.tiles.push({el,v});
  }
}

/** ç®€åŒ–é…å¯¹é€»è¾‘ï¼šç›¸åŒå³æ¶ˆé™¤ï¼ˆå‰ä¸¤å…³ï¼šæ¯æ¶ˆä¸€å¯¹ +1 ç§’ï¼Œæœ€å¤šå›æ»¡ï¼‰ */
function onPick(el,v){
  sfxClick();
  if(state.lock) return;
  if(!state.picked){ state.picked={el,v}; el.classList.add('selected'); return; }
  if(state.picked.el===el) return;

  if(state.picked.v!==v){
    state.picked.el.classList.remove('selected');
    state.picked={el,v}; el.classList.add('selected');
    return;
  }

  // ç›¸åŒï¼šæ¶ˆé™¤
  state.lock=true;
  const a=state.picked.el, b=el;
  a.classList.remove('selected'); a.classList.add('pop'); b.classList.add('pop');
  setTimeout(()=>{
    a.remove(); b.remove();
    state.tiles=state.tiles.filter(t=>t.el!==a && t.el!==b);
    state.lock=false; state.picked=null;

    // å¾—åˆ†
    state.score+=10; scoreEl.textContent=`å¾—åˆ† ${state.score}`;

    // âœ… å¥–åŠ±æ—¶é—´ï¼šä»…å‰ä¸¤å…³ï¼ˆlv=0,1ï¼‰ï¼Œæ¯æ¶ˆä¸€å¯¹ +1 ç§’ï¼›ä¸Šé™ä¸è¶…è¿‡æœ¬å…³æœ€å¤§æ—¶é•¿
    if(state.lv < 2){
      const before = state.timeLeft;
      state.timeLeft = Math.min(timerTotal, state.timeLeft + 1);
      if(state.timeLeft > before){
        sfxBonus();
        updateTimerUI(); // ç«‹åˆ»åˆ·æ–°è¿›åº¦æ¡/çŠ¶æ€
      }
    }

    if(state.tiles.length===0) showEnd(true);
  },250);
}

/** ç»“ç®— + è¯ä¹¦ï¼ˆåå­—å¯é€‰ï¼Œé»˜è®¤â€œç¥ç§˜ç©å®¶â€ï¼‰ */
function showEnd(win){
  clearTimer(); // ç»“æŸæ—¶åœæ­¢è®¡æ—¶ + æ¸…çŠ¶æ€
  if(win) sfxWin();
  const elapsed=Math.round((Date.now()-state.startTime)/1000);
  endTitle.textContent=win?'é€šå…³ï¼ğŸ‰':'æ—¶é—´åˆ°ï¼';
  endStats.textContent=`å¾—åˆ†ï¼š${state.score}ï½œç”¨æ—¶ï¼š${elapsed}s`;

  const displayName = nameInput.value?.trim() || 'ç¥ç§˜ç©å®¶';
  const url=makeCert({win,score:state.score,time:elapsed,lv:state.lv+1,name:displayName});
  certImg.src=url; btnDownload.href=url;

  endOverlay.style.display='flex';
}

/** ç‚¹å‡»â€œæ›´æ–°è¯ä¹¦â€æˆ–è¾“å…¥å›è½¦ï¼Œå®æ—¶åˆ·æ–° */
btnUpdateCert.onclick = ()=>regenerateCert();
nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); regenerateCert(); }});
function regenerateCert(){
  if(endOverlay.style.display==='none') return;
  const win = /é€šå…³/.test(endTitle.textContent);
  const elapsed = parseInt((endStats.textContent.match(/ç”¨æ—¶ï¼š(\d+)s/)||[])[1]||'0',10);
  const displayName = nameInput.value?.trim() || 'ç¥ç§˜ç©å®¶';
  const url=makeCert({win, score:state.score, time:elapsed, lv:state.lv+1, name:displayName});
  certImg.src=url; btnDownload.href=url;
}

/** è¯ä¹¦ç»˜åˆ¶ */
function makeCert({win,score,time,lv,name}){
  const w=900,h=600; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');

  const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#1a1440'); g.addColorStop(1,'#080816');
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='#7e5cef'; ctx.lineWidth=6; ctx.strokeRect(20,20,w-40,h-40);

  ctx.fillStyle='#fff'; ctx.font='bold 46px system-ui'; ctx.textAlign='center';
  ctx.fillText('ä¸‡åœ£èŠ‚é…å¯¹æŒ‘æˆ˜', w/2, 100);

  ctx.font='600 30px system-ui'; ctx.fillStyle='#a7ffea';
  ctx.fillText(`é¢å‘ç»™ï¼š${name}`, w/2, 160);

  ctx.font='28px system-ui'; ctx.fillStyle=win?'#2dd4bf':'#ff6b6b';
  ctx.fillText(win?'ğŸ‰ é€šå…³è®¤è¯':'ğŸ’€ æŒ‘æˆ˜ç»“æŸ', w/2, 210);

  ctx.textAlign='left'; ctx.fillStyle='#cfd0ff'; ctx.font='24px system-ui';
  ctx.fillText(`å…³å¡ï¼šLv.${lv}`, 100, 280);
  ctx.fillText(`å¾—åˆ†ï¼š${score}`, 100, 320);
  ctx.fillText(`ç”¨æ—¶ï¼š${time}s`, 100, 360);

  ctx.fillStyle='#9aa0ff';
  ctx.fillText(`æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN',{hour12:false})}`, 100, 420);

  ctx.textAlign='center'; ctx.fillStyle='#a7ffea'; ctx.font='22px system-ui';
  ctx.fillText('æ­å–œè·å¾—æœ¬æ¬¡æŒ‘æˆ˜è¯ä¹¦ ğŸƒï¼ˆå¯åˆ†äº«ï¼‰', w/2, 520);

  return c.toDataURL('image/png');
}
</script>
</body>
</html>
